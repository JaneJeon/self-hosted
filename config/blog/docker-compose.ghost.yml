version: "3"

services:
  ghost:
    image: ghost:4-alpine
    container_name: ghost-devblog
    restart: always
    entrypoint:
      - wait-for
      - mysql:3306
      - --
      - docker-entrypoint.sh
    networks:
      - public
      - private
    ports:
      - 3368:2368
    volumes:
      - ghost_devblog_content:/var/lib/ghost/content
      - ./scripts/wait-for:/usr/local/bin/wait-for
    environment:
      url: https://janejeon.dev
      database__client: mysql
      database__connection__host: mysql
      database__connection__user: ghost-devblog
      database__connection__password: ghost-devblog-password
      database__connection__database: devblog
      mail__transport: SMTP
      mail__options__service: SendGrid
      mail__options__auth__user: apikey
    labels:
      - traefik.enable=true
      - traefik.http.routers.devblog.rule=Host(`janejeon.dev`)
      - traefik.http.routers.devblog.tls.certresolver=letsencrypt
      - traefik.http.services.devblog.loadbalancer.server.port=3368

networks:
  public:
    external: true
  private:
    external: true

volumes:
  ghost_devblog_content:
    name: ghost_devblog_content
